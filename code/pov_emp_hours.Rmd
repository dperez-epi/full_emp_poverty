---
title: "pov_emp_hours"
author: "Daniel Perez"
date: "12/9/2021"
output: html_document
---

```{r libraries, include=FALSE}
library(tidyverse)
library(epiextractr)
library(epidatatools)
library(labelled)
library(here)
library(blsAPI)
library(openxlsx)
library(MetricsWeighted)
library(gtools)
library(statar)
```


```{r Load CPS}
cpi <- read_csv(here("input/cpi_annual.csv")) 
cpi_base <- cpi$cpiurs[cpi$year == 2019] 

cpsorg <-load_org(2009:2019, year, month, orgwgt, statefips, age, emp, selfemp, selfinc,
                  hourslwt, hourslw1, hourslw2, multjobs, hoursuorg, lfstat, earnhour, wage, weekpay) %>%
  filter(age>=16) %>%
  left_join(cpi, by='year') %>% 
  mutate(phours1 = ifelse(hourslw1>0 & !is.na(hourslw1), yes=1, no=0),
         phourst = ifelse(hourslwt>0 & !is.na(hourslwt), yes=1, no=0),
         realwage = wage*(cpi_base/cpiurs),
         realweekpay = weekpay*(cpi_base/cpiurs),
         pwages = ifelse(realwage>0 & !is.na(realwage) , yes=1, no=0),
         realwage0 = replace(realwage, emp==0, 0),
         hourslw0 = replace(hourslw1, emp==0, 0)) %>%   #inflation adjust to wages to 2019$ 
  mutate(selfemp0 = ifelse(selfemp==1 & !is.na(selfemp), yes=1, no=0),
         selfinc0 = ifelse(selfinc==1 & !is.na(selfinc), yes=1, no=0)) %>% 
  set_value_labels(pwages = c('Positive wages' = 1, 'Zero wages' = 0),
                   phours1 = c('Positive hours, primary job' = 1, 'Zero hours' =0),
                   phourst = c('Positive hours, total'=1, 'Zero hours' = 0))
```

```{r Refined sample}

cps <- cpsorg %>% 
  filter(selfemp0==0, selfemp0==0) %>% 
  filter((emp==1 & phours1== 1 & pwages==1) | (emp==0 & phours1==0 & pwages==0))
  
```

```{r Average hourly wages of employed }
hrly_wages <- cpsorg %>% 
  filter(pwages==1) %>% 
  group_by(year) %>% 
  summarize(wages_all = weighted.mean(realwage, w=orgwgt/12, na.rm=TRUE),
            ptile20 = weighted_quantile(realwage, w = orgwgt/12, probs = 0.20, na.rm=TRUE),
            ptile40 = weighted_quantile(realwage, w = orgwgt/12, probs = 0.40, na.rm=TRUE),
            ptile50 = weighted_quantile(realwage, w = orgwgt/12, probs = 0.50, na.rm=TRUE),
            ptile60 = weighted_quantile(realwage, w = orgwgt/12, probs = 0.60, na.rm=TRUE),
            ptile80 = weighted_quantile(realwage, w = orgwgt/12, probs = 0.80, na.rm=TRUE))

weeklywages <- cpsorg %>% 
  filter(emp==1, pwages==1, selfemp==0, selfinc==0) %>% 
  group_by(year) %>%
  summarize(weekpay_all = weighted.mean(realweekpay, w=orgwgt/12, na.rm=TRUE),
            ptile20 = weighted_quantile(realweekpay, w = orgwgt/12, probs = 0.20, na.rm=TRUE),
            ptile40 = weighted_quantile(realweekpay, w = orgwgt/12, probs = 0.40, na.rm=TRUE),
            ptile50 = weighted_quantile(realweekpay, w = orgwgt/12, probs = 0.50, na.rm=TRUE),
            ptile60 = weighted_quantile(realweekpay, w = orgwgt/12, probs = 0.60, na.rm=TRUE),
            ptile80 = weighted_quantile(realweekpay, w = orgwgt/12, probs = 0.80, na.rm=TRUE))

avg_hours <- cpsorg %>% 
  filter(selfemp==0, selfinc==0) %>% 
  group_by(year) %>% 
  summarize(hours_all = weighted.mean(hourslw1, w=orgwgt/12, na.rm=TRUE),
            ptile20 = weighted_quantile(hourslw1, w = orgwgt/12, probs = 0.20, na.rm=TRUE),
            ptile40 = weighted_quantile(hourslw1, w = orgwgt/12, probs = 0.40, na.rm=TRUE),
            ptile50 = weighted_quantile(hourslw1, w = orgwgt/12, probs = 0.50, na.rm=TRUE),
            ptile60 = weighted_quantile(hourslw1, w = orgwgt/12, probs = 0.60, na.rm=TRUE),
            ptile80 = weighted_quantile(hourslw1, w = orgwgt/12, probs = 0.80, na.rm=TRUE))
```

```{r}
set.seed(197)
test <- rnorm(8000, mean=-4, sd=1)
```


```{r Sample validation}

#assessment and removal of folks with inconsistent earnings/hours/employment status
phours_pwages_by_empstat_fmt <- cpsorg %>% 
  filter(selfemp0==0, selfinc0==0) %>%
  group_by(year, emp, pwages, phours1) %>% 
  summarize(n = n()) %>% 
  group_by(year) %>% 
  mutate(freq = n/sum(n)) %>% 
  ungroup() %>% 
  filter((emp==1 & phours1== 1 & pwages==1) | (emp==0 & phours1==0 & pwages==0)) %>% 
  mutate(across(pwages|phours1|emp, ~ to_factor(.x)))

phours_pwages_by_empstat_raw <- cpsorg %>% 
  filter(selfemp0==0, selfinc0==0) %>%
  group_by(year, emp, pwages, phours1) %>% 
  summarize(n = n()) %>% 
  group_by(year) %>% 
  mutate(freq = n/sum(n)) %>% 
  ungroup() %>% 
  mutate(across(pwages|phours1|emp, ~ to_factor(.x))) 

phours_pwages_by_empstat_raw_under65 <- cps %>% 
  filter(selfemp0==0, selfinc0==0, age<65) %>%
  group_by(year, emp, pwages, phours1) %>% 
  summarize(n = n(),
            wgt_n = sum(orgwgt/12)) %>% 
  group_by(year) %>% 
  mutate(freq = n/sum(n),
         freq_wgt = wgt_n/sum(wgt_n)) %>% 
  ungroup() %>% 
  mutate(across(pwages|phours1|emp, ~ to_factor(.x))) %>% 
  arrange(year,-n, wgt_n) %>% 
  write_csv(here('data/samples_under65.csv'), col_names = TRUE)

phours_pwages_by_empstat_raw_16plus <- cps %>% 
  filter(selfemp0==0, selfinc0==0, age<65) %>%
  group_by(year, emp, pwages, phours1) %>% 
  summarize(n = n(),
            wgt_n = sum(orgwgt/12)) %>% 
  group_by(year) %>% 
  mutate(freq = n/sum(n),
         freq_wgt = wgt_n/sum(wgt_n)) %>% 
  ungroup() %>% 
  mutate(across(pwages|phours1|emp, ~ to_factor(.x))) %>% 
  arrange(year,-n, wgt_n) %>% 
  write_csv(here('data/samples_16plus.csv'), col_names = TRUE)

self_emp <- cpsorg %>% 
  mutate(selfemp = to_factor(selfemp)) %>% 
  group_by(year,selfemp) %>% 
  tally()

```



```{r Hours and wages with zeros}
hrly_wage0_under65 <- cps %>%
  filter(age<65) %>% 
  group_by(year) %>% 
  summarize(avg_wage_all = weighted.mean(realwage0, w=orgwgt/12, na.rm=TRUE),
            ptile20 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.20, na.rm=TRUE),
            ptile40 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.40, na.rm=TRUE),
            ptile50 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.50, na.rm=TRUE),
            ptile60 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.60, na.rm=TRUE),
            ptile80 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.80, na.rm=TRUE),
            ptile99 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.99, na.rm=TRUE),
            share_positive_wages = weighted.mean(pwages, w = orgwgt/12, na.rm=TRUE))# %>% 
  pivot_longer(!c(year,avg_wage_all), names_to = 'wage_quantile', values_to = 'cutoff')

hrly_wage0_16plus <- cps %>%
  group_by(year) %>% 
  summarize(wages_all = weighted.mean(realwage0, w=orgwgt/12, na.rm=TRUE),
            ptile20 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.20, na.rm=TRUE),
            ptile40 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.40, na.rm=TRUE),
            ptile50 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.50, na.rm=TRUE),
            ptile60 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.60, na.rm=TRUE),
            ptile80 = weighted_quantile(realwage0, w = orgwgt/12, probs = 0.80, na.rm=TRUE),
            share_positive_wages = weighted.mean(pwages, w = orgwgt/12, na.rm=TRUE))

hrs_wgs_under65 <- cps %>% 
  filter(age<65) %>% 
  group_by(year) %>%
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(year, wage_rank) %>% 
  summarize(wagerank_avg = mean(realwage0, na.rm=TRUE),
            cutoffs = max(realwage0, na.rm=TRUE),
            avg_hrs = mean(hourslw0, na.rm=TRUE),
            n=n())

hrs_wgs_16plus <- cps %>% 
  group_by(year) %>%
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(year, wage_rank) %>% 
  summarize(wagerank_avg = mean(realwage0, na.rm=TRUE),
            cutoffs = max(realwage0, na.rm=TRUE),
            avg_hrs = mean(hourslw0, na.rm=TRUE),
            n=n())

hrs_wgs_under65_wgt <- cps %>% 
  filter(age<65) %>% 
  group_by(year) %>%
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(year, wage_rank) %>% 
  summarize(wagerank_avg = mean(realwage0, na.rm=TRUE),
            cutoffs = max(realwage0, na.rm=TRUE),
            avg_hrs = mean(hourslw0, na.rm=TRUE),
            n=n(),
            wgt_n = sum(orgwgt/12))

hrs_wgs_16plus_wgt <- cps %>% 
  group_by(year) %>%
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(year, wage_rank) %>% 
  mutate()
  summarize(wagerank_avg = mean(realwage0, na.rm=TRUE),
            cutoffs = max(realwage0, na.rm=TRUE),
            avg_hrs = mean(hourslw0, na.rm=TRUE),
            n=n())

stats_under65 <- cps %>% 
  filter(age<65) %>% 
  group_by(year) %>%
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(year) %>% 
  summarize(employment = weighted.mean(emp, w=orgwgt/12, na.rm=TRUE),
            positive_hours = weighted.mean(phours1, w=orgwgt/12, na.rm=TRUE),
            positive_wages = weighted.mean(pwages, w=orgwgt/12, na.rm=TRUE),
            n=n())

stats_16plus <- cps %>% 
  group_by(year) %>%
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(year) %>% 
  summarize(employment = weighted.mean(emp, w=orgwgt/12, na.rm=TRUE),
            positive_hours = weighted.mean(phours1, w=orgwgt/12, na.rm=TRUE),
            positive_wages = weighted.mean(pwages, w=orgwgt/12, na.rm=TRUE),
            n=n())

employment <- cps %>% 
  mutate(wage_rank = xtile(realwage0, n=5, wt=orgwgt/12)) %>% 
  group_by(wage_rank) %>% 
  summarize(employment = weighted.mean(emp, w=orgwgt/12, na.rm=TRUE))


```




```{r Hours calculations by state}

epops25_54 <- cpsorg %>% 
  filter(age>=25 & age<=54) %>% 
  mutate(statefips = to_factor(statefips)) %>% 
  group_by(year, statefips) %>% 
  summarize(epop25_54 = sum(emp * orgwgt/12, na.rm=TRUE) / sum(orgwgt/12))
#  pivot_wider(id_cols = statefips, names_from=year, values_from = epop25_54)

epops_16plus <- cpsorg %>% 
  filter(age>=16, year==2019) %>% 
  mutate(statefips = to_factor(statefips)) %>% 
  group_by(year, statefips) %>% 
  summarize(epop_16plus = sum(emp * orgwgt/12, na.rm=TRUE) / sum(orgwgt/12))# %>% 
#  pivot_wider(id_cols = statefips, names_from=year, values_from = epop_16plus)

hours_16plus <- cpsorg %>% 
  filter(age>=16, lfstat==1) %>% 
#  mutate(statefips = to_factor(statefips)) %>% 
  group_by(year) %>% 
  summarize(hourslw_total = weighted.mean(hourslwt,w = orgwgt/12, na.rm=TRUE),
            hourslw_primary = weighted.mean(hourslw1, w=orgwgt/12, na.rm=TRUE))# %>% 
#  pivot_wider(id_cols = statefips, names_from=year, values_from = hours_16plus)

hours25_54 <- cpsorg %>% 
  filter(age>=25 & age<=54) %>% 
  mutate(statefips = to_factor(statefips)) %>% 
  group_by(year, statefips) %>% 
  summarize(hours25_54 = weighted.mean(hourslwt,w = orgwgt/12, na.rm=TRUE))# %>% 
#  pivot_wider(id_cols = statefips, names_from=year, values_from = hours25_54)
  
```


```{r}

epophours <- createWorkbook()

addWorksheet(epophours, sheetName = "Epops 16+")
addWorksheet(epophours, sheetName = "Epops 25-54")
addWorksheet(epophours, sheetName = "Avg hours 16+")
addWorksheet(epophours, sheetName = "Avg hours 25-54")
addWorksheet(epophours, sheetName = "Avg wages 16+")
addWorksheet(epophours, sheetName = "Avg wages 25-54")



writeData(epophours, epops_16plus, sheet = "Epops 16+", startCol = 1, startRow = 1, colNames = TRUE)
writeData(epophours, epops25_54, sheet = "Epops 25-54", startCol = 1, startRow = 1, colNames = TRUE)
writeData(epophours, hours_16plus, sheet = "Avg hours 16+", startCol = 1, startRow = 1, colNames = TRUE)
writeData(epophours, hours25_54, sheet = "Avg hours 25-54", startCol = 1, startRow = 1, colNames = TRUE)


saveWorkbook(epophours, here("data/hours_epops.xlsx"), overwrite = TRUE)
```

